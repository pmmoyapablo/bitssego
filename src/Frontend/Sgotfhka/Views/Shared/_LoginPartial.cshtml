@using Microsoft.AspNetCore.Identity
@using Sisgtfhka.Models



@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager

@if (SignInManager.IsSignedIn(User))
{
    List<MenuModel> listMenus = new List<MenuModel>();
    List<MenuModel> listSubMenus = new List<MenuModel>();

    try
    {
        var userIdentity = await UserManager.GetUserAsync(User);

        var claims = await UserManager.GetClaimsAsync(userIdentity);
        if (claims.Count > 0)
        {
            var claim = claims.FirstOrDefault();
            string repJson = claim.Value;

            listMenus = TypeModel<MenuModel>.DeserializeInArray(repJson);
            listSubMenus = listMenus.Where(e => e.parentId != 0 && e.visible == true).OrderBy(sm => sm.order).ToList();
            listMenus = listMenus.Where(e => e.parentId == 0 && e.visible == true).OrderByDescending(m => m.order).ToList();
        }

    }
    catch (Exception ex)
    {

    }

    <ul class="nav navbar-nav">
        @foreach (MenuModel m in listMenus)
        {
            List<MenuModel> sms = listSubMenus.Where(e => e.parentId == m.id).ToList();
            <li class="dropdown">
                <a href="@m.url" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">@m.name  <span class="caret"></span></a>

                @if (sms.Count > 0)
                {
                    <ul class="dropdown-menu">
                        @foreach (MenuModel sm in sms)
                        {
                            <li><a asp-area="" asp-controller=@sm.url asp-action=@sm.view>@sm.name</a></li>
                        }
                    </ul>
                }
            </li>
        }
    </ul>
    <form asp-area="" asp-controller="Account" asp-action="Logout" method="post" id="logoutForm" class="navbar-right dropdown">
        <div class="navbar-collapse collapse navbar-right" id="">
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><i class="fas fa-user"></i>  <span class="caret"></span></a>

                    <ul class="dropdown-menu">

                        <li><a asp-controller="Manage" asp-action="Index">@UserManager.GetUserName(User)</a></li>
                        <li><a href="javascript:document.getElementById('logoutForm').submit()">Cerrar Sesi&oacute;n</a></li>

                    </ul>
                </li>
            </ul>
        </div>
    </form>
}
else
{
    <ul class="nav navbar-nav navbar-right">
        <li><a asp-area="" asp-controller="Account" asp-action="Login">Iniciar Sesi&oacute;n</a></li>
    </ul>
}


